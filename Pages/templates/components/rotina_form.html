{% extends "components/base.html" %}
{% load static %}

{% block title %}Nova rotina{% endblock %}

{% block head-base %}
<style>
  /* Linha de detalhes recolh√≠vel */
  .detalhes-row { background-color:#f8f9fa; }
  .detalhes-row.d-none { display:none; }
  
  /* Estilo para o grupo muscular */
  .grupo-muscular-badge {
    display: inline-block;
    background-color: #e9ecef;
    color: #495057;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-top: 0.25rem;
  }
  
  /* Estilo para linhas selecionadas */
  .table-active {
    background-color: rgba(13, 71, 161, 0.1) !important;
  }
  
  /* Notifica√ß√µes */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 20px;
    background: white;
    border-left: 4px solid #0d47a1;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    z-index: 1050;
    max-width: 350px;
    border-radius: 4px;
    transition: all 0.3s ease;
  }
  
  .notification.success {
    border-left-color: #28a745;
  }
  
  .notification.error {
    border-left-color: #dc3545;
  }
</style>
{% endblock %}

{% block body-base %}
<div class="container-fluid py-4">

  <!-- Cabe√ßalho --------------------------------------------------------- -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="mb-0">Cadastrar rotina ‚Äì {{ aluno.nome }}</h2>
    <!-- Bot√£o de voltar -->
    <a href="{% url 'view_aluno' aluno.id %}" class="btn btn-outline-secondary">
      Voltar
    </a>
  </div>

  <!-- *** Conte√∫do original do modal convertido em p√°gina 100 % width *** -->
  <!-- Abas de navega√ß√£o entre s√©ries -->
  <ul class="nav nav-tabs mb-3" id="abasTreino" role="tablist">
    <li class="nav-item" id="liAdicionarSerie">
      <button class="btn btn-sm btn-outline-secondary" onclick="mostrarInputNovaSerie()">+ Nova S√©rie</button>
    </li>
    <li class="nav-item d-none" id="liInputSerie">
      <input type="text" id="inputNomeSerie" class="form-control form-control-sm" placeholder="Nome da s√©rie">
    </li>
  </ul>

  <!-- Conte√∫do din√¢mico das abas -->
  <div class="tab-content container-fluid px-0" id="conteudoTreinos"></div>

  <!-- Anota√ß√µes gerais do treino -->
  <div class="mt-4">
    <label for="anotacoes" class="form-label">Anota√ß√µes</label>
    <textarea class="form-control" id="anotacoes" rows="3" placeholder="Informa√ß√µes gerais do treino"></textarea>
  </div>
  
  <!-- Gr√°fico de distribui√ß√£o muscular -->
  <div id="modalBodyGraph" class="relative w-full max-w-md mt-4">
    <!-- O fetch() vai trocar este div pelo SVG inline -->
    <div id="body-graph-placeholder" class="text-center py-8 text-gray-400">
      Carregando gr√°fico...
    </div>
  </div>

  <!-- Rodap√© -->
  <div class="mt-4 d-flex justify-content-end gap-2">
    <a href="{% url 'view_aluno' aluno.id %}" class="btn btn-secondary">Cancelar</a>
    <button type="button" class="btn btn-primary" id="btnSalvarTreino" onclick="salvarTreino()">Salvar rotina</button>
  </div>

</div>

<!-- Modal de edi√ß√£o em massa -->
<div class="modal fade" id="edicaoMassaModal" tabindex="-1" aria-labelledby="edicaoMassaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="edicaoMassaLabel">
          <i class="bi bi-pencil-square me-2"></i>Edi√ß√£o em Massa
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <form id="formEdicaoMassa">
          <div class="mb-3">
            <label class="form-label" for="massa_carga">Carga (kg)</label>
            <input type="number" step="0.1" class="form-control" id="massa_carga" placeholder="Ex: 20.5">
          </div>
          <div class="mb-3">
            <label class="form-label" for="massa_repsDesejadas">Repeti√ß√µes Desejadas</label>
            <input type="number" class="form-control" id="massa_repsDesejadas" placeholder="Ex: 12">
          </div>
          <div class="mb-3">
            <label class="form-label" for="massa_sets">S√©ries</label>
            <input type="number" class="form-control" id="massa_sets" placeholder="Ex: 3">
          </div>
          <div class="mb-3">
            <label class="form-label" for="massa_descanso">Descanso (segundos)</label>
            <input type="number" class="form-control" id="massa_descanso" placeholder="Ex: 60">
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnAplicarEdicaoMassa">
          <i class="bi bi-check-circle me-1"></i>Aplicar Altera√ß√µes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Incluir o modal de cadastro de exerc√≠cio -->
{% include 'components/modal/modalCadExercicio.html' %}

<!-- Scripts JS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
/*****************  1. CACHE GLOBAL DE EXERC√çCIOS  *****************/
let exercisesCache = null;
let isLoadingExercises = false;

// Sistema de cache otimizado com sessionStorage
const CacheManager = {
  CACHE_KEY: 'exercisesCache',
  CACHE_TIMESTAMP_KEY: 'exercisesCacheTimestamp',
  CACHE_DURATION: 30 * 60 * 1000, // 30 minutos

  isValid() {
    const timestamp = sessionStorage.getItem(this.CACHE_TIMESTAMP_KEY);
    if (!timestamp) return false;
    
    const now = Date.now();
    const cacheTime = parseInt(timestamp);
    return (now - cacheTime) < this.CACHE_DURATION;
  },

  get() {
    if (!this.isValid()) {
      this.clear();
      return null;
    }
    
    const data = sessionStorage.getItem(this.CACHE_KEY);
    return data ? JSON.parse(data) : null;
  },

  set(data) {
    sessionStorage.setItem(this.CACHE_KEY, JSON.stringify(data));
    sessionStorage.setItem(this.CACHE_TIMESTAMP_KEY, Date.now().toString());
  },

  clear() {
    sessionStorage.removeItem(this.CACHE_KEY);
    sessionStorage.removeItem(this.CACHE_TIMESTAMP_KEY);
  }
};

// Fun√ß√£o otimizada para carregar exerc√≠cios
async function carregarExercicios() {
  if (isLoadingExercises) {
    console.log('‚è≥ Carregamento j√° em andamento...');
    return exercisesCache || [];
  }

  console.log('üîÑ Carregando exerc√≠cios...');
  
  // Verifica cache v√°lido
  const cachedData = CacheManager.get();
  if (cachedData) {
    console.log('‚úÖ Exerc√≠cios carregados do cache:', cachedData.length);
    exercisesCache = cachedData;
    return exercisesCache;
  }

  // Busca da API
  isLoadingExercises = true;
  try {
    const response = await fetch('{% url "exercicios_json" %}?q=');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    exercisesCache = data.results || [];
    
    // Salva no cache
    CacheManager.set(exercisesCache);
    
    console.log('‚úÖ Exerc√≠cios carregados da API:', exercisesCache.length);
    return exercisesCache;
    
  } catch (error) {
    console.error('‚ùå Erro ao carregar exerc√≠cios:', error);
    mostrarNotificacao(`Erro ao carregar exerc√≠cios: ${error.message}`, 'error');
    return [];
  } finally {
    isLoadingExercises = false;
  }
}

// Fun√ß√£o otimizada para filtrar exerc√≠cios
function filtrarExercicios(termo) {
  if (!exercisesCache) return [];
  if (!termo || termo.length < 2) return [];
  
  const termoLower = termo.toLowerCase();
  return exercisesCache
    .filter(ex => ex.nome.toLowerCase().includes(termoLower))
    .slice(0, 20);
}

/*****************  2. CONFIGURA√á√ÉO SELECT2 OTIMIZADA  *****************/
function configurarSelect2Exercicio($select) {
  console.log('üîß Configurando Select2 para:', $select.attr('id') || 'select sem ID');
  
  // Destr√≥i inst√¢ncia existente
  if ($select.hasClass('select2-hidden-accessible')) {
    $select.select2('destroy');
  }

  // Remove atributos conflitantes
  $select.removeAttr('aria-readonly readonly disabled');
  $select.prop('disabled', false);

  const config = {
    theme: 'bootstrap-5',
    placeholder: 'Digite para buscar exerc√≠cio...',
    minimumInputLength: 2,
    allowClear: true,
    width: '100%',
    ajax: {
      transport: function(params, success, failure) {
        const termo = params.data.q || '';
        
        // Mostra loading
        const $container = $select.next('.select2-container');
        if ($container.length) {
          $container.addClass('select2-container--loading');
        }
        
        setTimeout(() => {
          try {
            const resultados = filtrarExercicios(termo);
            
            success({
              results: resultados.map(item => ({
                id: item.id,
                text: item.nome,
                nome: item.nome,
                descricao: item.descricao || '',
                categoria: item.categoria || '',
                grupo_muscular: item.grupo_muscular || ''
              }))
            });
          } catch (error) {
            console.error('‚ùå Erro na busca:', error);
            failure();
          } finally {
            if ($container.length) {
              $container.removeClass('select2-container--loading');
            }
          }
        }, 150); // Delay para UX
      },
      delay: 300,
      cache: true
    },
    language: {
      noResults: function() {
        return '<div class="select2-results__option select2-results__option--cadastrar-exercicio">' +
               '<button type="button" class="btn-cadastrar-exercicio" onclick="abrirModalCadastroExercicio()">' +
               '<i class="bi bi-plus-circle me-1"></i> Cadastrar novo exerc√≠cio' +
               '</button></div>';
      },
      inputTooShort: function() {
        return '<div class="text-muted p-2">Digite pelo menos 2 caracteres para buscar</div>';
      },
      searching: function() {
        return '<div class="text-muted p-2"><span class="loading-spinner me-2"></span>Buscando exerc√≠cios...</div>';
      },
      errorLoading: function() {
        return '<div class="text-danger p-2">Erro ao carregar exerc√≠cios</div>';
      }
    },
    escapeMarkup: function(markup) {
      return markup;
    }
  };

  try {
    $select.select2(config);
    console.log('‚úÖ Select2 inicializado com sucesso');
    
    // Event listeners
    $select.on('select2:select', function (e) {
      const data = e.params.data;
      console.log('üéØ Exerc√≠cio selecionado:', data.text);
      
      atualizarGrupoMuscular($select, data);
      
      // Atualizar o gr√°fico corporal quando um exerc√≠cio √© selecionado
      if (data.grupo_muscular) {
        atualizarGraficoMuscular(data.grupo_muscular);
      }
    });

    $select.on('select2:clear', function () {
      console.log('üóëÔ∏è Exerc√≠cio removido');
      atualizarGrupoMuscular($select, null);
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao inicializar Select2:', error);
    mostrarNotificacao('Erro ao configurar busca de exerc√≠cios', 'error');
  }
}

/*****************  3. EXIBI√á√ÉO DIN√ÇMICA DE GRUPOS MUSCULARES  *****************/
function atualizarGrupoMuscular($select, exercicioData) {
  const container = $select.closest('td');
  let grupoInfo = container.find('.grupo-muscular-info');
  
  // Remove info existente
  grupoInfo.remove();
  
  // Adiciona nova info se exerc√≠cio foi selecionado
  if (exercicioData && exercicioData.grupo_muscular) {
    const grupoFormatado = formatarGrupoMuscular(exercicioData.grupo_muscular);
    const grupoHtml = `
      <div class="grupo-muscular-info">
        <i class="bi bi-tag-fill"></i>
        <span class="grupo-muscular-badge">${grupoFormatado}</span>
      </div>`;
    container.append(grupoHtml);
  }
}

function formatarGrupoMuscular(grupo) {
  const grupos = {
    'trapezius': 'Trap√©zio',
    'chest': 'Peitoral',
    'back': 'Costas',
    'shoulders': 'Ombros',
    'biceps': 'B√≠ceps',
    'triceps': 'Tr√≠ceps',
    'brachialis': 'Braquial',
    'forearms': 'Antebra√ßos',
    'abs': 'Abd√¥men',
    'obliques': 'Obl√≠quos',
    'lombar': 'Lombar',
    'iliopsoas': 'Iliopsoas',
    'glutes': 'Gl√∫teos',
    'quadriceps': 'Quadr√≠ceps',
    'hamstrings': 'Posterior',
    'calves': 'Panturrilhas',
    'adductors': 'Adutores',
    'abductors': 'Abdutores',
    'cardio': 'Cardio'
  };
  
  return grupos[grupo] || grupo;
}

/*****************  4. GR√ÅFICO CORPORAL INLINE  *****************/
/* Mapa dos grupos musculares ‚Üí cor */
const COLORS = {
  ativo: '#00D4FF',
  inativo: '#CBD5E1',
};

/* Pinta grupos recebidos do backend */
function colorirMusculos(musculosAtivos = []) {
  const svg = window.bodyGraph;
  if (!svg) return;                      // SVG ainda n√£o carregou

  // Itera sobre <g id="..."> dentro do SVG
  svg.querySelectorAll('path[id]').forEach(path => {
    const id = path.id.replace(/\d+$/, '');  // Remove n√∫meros no final (ex: biceps2 -> biceps)
    const ativo = musculosAtivos.includes(id);
    path.style.fill = ativo ? COLORS.ativo : COLORS.inativo;
    path.style.cursor = 'pointer';
    
    // Adiciona evento de clique para alternar o estado
    path.addEventListener('click', () => {
      const novoEstado = path.style.fill === COLORS.ativo ? COLORS.inativo : COLORS.ativo;
      // Encontra todos os elementos com o mesmo ID base (ex: biceps, biceps2)
      const idBase = id.replace(/\d+$/, '');
      svg.querySelectorAll(`path[id^="${idBase}"]`).forEach(p => {
        p.style.fill = novoEstado;
      });
    });
  });
}

// Fun√ß√£o para atualizar o gr√°fico quando um exerc√≠cio √© selecionado
function atualizarGraficoMuscular(grupoMuscular) {
  // Converte para array se for string
  const grupos = Array.isArray(grupoMuscular) ? grupoMuscular : [grupoMuscular];
  colorirMusculos(grupos);
}

// Carrega o SVG inline
function carregarGraficoMuscular() {
  fetch("{% static 'img/body-graph.svg' %}")
    .then(r => r.text())
    .then(svgText => {
      // Injeta no DOM
      const wrapper = document.getElementById('modalBodyGraph');
      if (wrapper) {
        wrapper.innerHTML = svgText;
        
        // Guarda refer√™ncia para manipula√ß√£o posterior
        window.bodyGraph = wrapper.querySelector('svg');
        
        // Inicializa com todos os m√∫sculos inativos
        colorirMusculos([]);
      }
    })
    .catch(error => {
      console.error('Erro ao carregar SVG:', error);
      if (document.getElementById('body-graph-placeholder')) {
        document.getElementById('body-graph-placeholder').innerHTML = 
          'Erro ao carregar o gr√°fico corporal.';
      }
    });
}

/*****************  5. GEST√ÉO COMPLETA DE TREINOS  *****************/
async function salvarTreino() {
  console.log('üíæ Iniciando salvamento do treino...');
  
  const btnSalvar = document.getElementById('btnSalvarTreino');
  const textoOriginal = btnSalvar.innerHTML;
  
  try {
    // Feedback visual
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
    
    // Valida√ß√£o e coleta de dados
    const dadosTreino = await coletarDadosTreino();
    
    if (!dadosTreino.series || dadosTreino.series.length === 0) {
      throw new Error('Adicione pelo menos uma s√©rie ao treino');
    }

    // Valida√ß√£o adicional
    const totalExercicios = dadosTreino.series.reduce((total, serie) => total + serie.exercicios.length, 0);
    if (totalExercicios === 0) {
      throw new Error('Adicione pelo menos um exerc√≠cio ao treino');
    }

    // Envia via AJAX
    const response = await fetch('{% url "salvar_treino" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(dadosTreino)
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
    }

    const resultado = await response.json();
    
    if (resultado.success) {
      console.log('‚úÖ Treino salvo com sucesso:', resultado);
      
      // Feedback de sucesso
      mostrarNotificacao(
        `Treino salvo com sucesso! ${resultado.treinos.length} s√©rie(s) criada(s).`, 
        'success'
      );
      
      // Redireciona para a p√°gina do aluno
      window.location.href = `/aluno/${dadosTreino.aluno_id}/`;
      
    } else {
      throw new Error(resultado.message || 'Erro desconhecido ao salvar treino');
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar treino:', error);
    mostrarNotificacao(`Erro ao salvar treino: ${error.message}`, 'error');
  } finally {
    // Restaura bot√£o
    btnSalvar.disabled = false;
    btnSalvar.innerHTML = textoOriginal;
  }
}

async function coletarDadosTreino() {
  const anotacoes = document.getElementById('anotacoes').value.trim();
  const series = [];
  
  // Coleta dados de cada s√©rie
  const tabPanes = document.querySelectorAll('.tab-pane[id^="treino_"]');
  
  for (const tabPane of tabPanes) {
    const nomeAba = document.querySelector(`a[href="#${tabPane.id}"]`)?.textContent?.trim();
    if (!nomeAba) continue;
    
    const exercicios = [];
    const exercicioRows = tabPane.querySelectorAll('.exercicio-row');
    
    for (const row of exercicioRows) {
      const $selectExercicio = $(row).find('.select-exercicio');
      
      if (!$selectExercicio.hasClass('select2-hidden-accessible')) {
        console.warn('‚ö†Ô∏è Select2 n√£o inicializado para linha');
        continue;
      }
      
      const exercicioData = $selectExercicio.select2('data')[0];
      if (!exercicioData) continue;
      
      const exercicio = {
        exercicio_id: exercicioData.id,
        nome: exercicioData.nome,
        carga: parseFloat(row.querySelector('[data-field="carga"] input')?.value) || 0,
        reps_desejadas: parseInt(row.querySelector('[data-field="repsDesejadas"] input')?.value) || 0,
        sets: parseInt(row.querySelector('[data-field="sets"] input')?.value) || 0,
        descanso: parseInt(row.querySelector('[data-field="descanso"] input')?.value) || 0,
        metodo: row.querySelector('[data-field="metodo"] select')?.value || '',
        notas: row.nextElementSibling?.querySelector('[data-field="notas"]')?.value?.trim()
      };
      
      exercicios.push(exercicio);
    }
    
    if (exercicios.length > 0) {
      series.push({
        nome: nomeAba,
        exercicios: exercicios
      });
    }
  }
  
  // Obt√©m o ID do aluno da URL
  const alunoId = {{ aluno.id }};
  
  return {
    aluno_id: alunoId,
    anotacoes: anotacoes,
    series: series
  };
}

function getCSRFToken() {
  // Tenta obter do cookie
  const cookieValue = document.cookie
    .split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
  
  if (cookieValue) return cookieValue;
  
  // Tenta obter de um campo oculto
  const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
  if (csrfInput) return csrfInput.value;
  
  console.warn('‚ö†Ô∏è CSRF token n√£o encontrado');
  return '';
}

function mostrarNotificacao(mensagem, tipo = 'info') {
  // Remove notifica√ß√µes existentes
  document.querySelectorAll('.notification').forEach(el => el.remove());
  
  // Cria nova notifica√ß√£o
  const notificacao = document.createElement('div');
  notificacao.className = `notification ${tipo}`;
  notificacao.innerHTML = `
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <i class="bi ${tipo === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
        ${mensagem}
      </div>
      <button type="button" class="btn-close ms-3" onclick="this.parentNode.parentNode.remove()"></button>
    </div>
  `;
  
  document.body.appendChild(notificacao);
  
  // Remove automaticamente ap√≥s 5 segundos
  setTimeout(() => {
    notificacao.style.opacity = '0';
    notificacao.style.transform = 'translateX(100%)';
    notificacao.style.transition = 'opacity 0.3s, transform 0.3s';
    
    setTimeout(() => {
      notificacao.remove();
    }, 300);
  }, 5000);
}

/*****************  6. FUN√á√ïES DE CADASTRO DE EXERC√çCIO  *****************/
function abrirModalCadastroExercicio() {
  console.log('üÜï Abrindo modal de cadastro de exerc√≠cio');
  
  // Fecha o dropdown do Select2
  $('.select-exercicio').select2('close');
  
  // Abre o modal de cadastro
  const modal = new bootstrap.Modal(document.getElementById('modalCadExercicio'));
  modal.show();
}

function recarregarExercicios() {
  console.log('üîÑ Recarregando cache de exerc√≠cios...');
  
  // Limpa o cache
  exercisesCache = null;
  CacheManager.clear();
  
  // Recarrega o cache
  carregarExercicios().then(() => {
    console.log('‚úÖ Cache de exerc√≠cios recarregado');
    
    // Reinicializa todos os selects
    $('.select-exercicio').each(function() {
      const $this = $(this);
      const valorAtual = $this.val();
      
      // Reinicializa o Select2
      configurarSelect2Exercicio($this);
      
      // Restaura o valor se havia algum selecionado
      if (valorAtual) {
        const exercicioAtual = exercisesCache.find(e => e.id == valorAtual);
        if (exercicioAtual) {
          const option = new Option(exercicioAtual.nome, exercicioAtual.id, true, true);
          $this.append(option).trigger('change');
        }
      }
    });
  });
}

/*****************  7. MANIPULA√á√ÉO DE M√âTODO *****************/
function handleMetodoChange(selectEl) {
  const metodo = selectEl.value;
  const mainRow = selectEl.closest('tr.exercicio-row');
  const detalhesRow = mainRow.nextElementSibling;
  
  if (!metodo) { 
    detalhesRow.classList.add('d-none'); 
    return; 
  }
  
  detalhesRow.classList.remove('d-none');
  recalcularLinha(mainRow);
}

/*****************  8. CRUD de Exerc√≠cios e S√©ries ***********/
function adicionarExercicio(treinoId) {
  console.log('‚ûï Adicionando exerc√≠cio para treino:', treinoId);
  
  const tabela = document.getElementById(`tabelaExercicios_${treinoId}`);
  if (!tabela) {
    console.error('‚ùå Tabela n√£o encontrada:', `tabelaExercicios_${treinoId}`);
    return;
  }
  
  const uid = Math.random().toString(36).slice(2,7);
  const selectId = `select_exercicio_${uid}`;

  const linhaPrincipal = `
    <tr class="exercicio-row" id="row_${uid}">
      <td class="text-center"><input class="form-check-input mass-check" type="checkbox"></td>
      <td data-field="nome">
        <select id="${selectId}" class="form-select select-exercicio" style="width: 100%;">
          <option></option>
        </select>
      </td>
      <td data-field="carga"><input class="form-control" type="number" placeholder="kg" step="0.1"></td>
      <td data-field="repsDesejadas"><input class="form-control" type="number" placeholder="reps"></td>
      <td data-field="sets"><input class="form-control" type="number" min="1" placeholder="sets"></td>
      <td data-field="descanso"><input class="form-control" type="number" placeholder="seg"></td>
      <td data-field="metodo">
        <select class="form-select" onchange="handleMetodoChange(this)">
          <option value="">Tradicional</option>
          <option value="drop_set">Drop Set</option>
          <option value="bi_set">Superset / Bi-set</option>
          <option value="rest_pause">Rest Pause</option>
          <option value="piramidal">Piramidal</option>
          <option value="negativa">Negativa</option>
        </select>
      </td>
    </tr>`;

  const linhaDetalhes = `
    <tr class="detalhes-row d-none" data-parent="row_${uid}">
      <td colspan="7"><input class="form-control" data-field="notas" placeholder="Notas / Resultado"></td>
    </tr>`;

  tabela.insertAdjacentHTML('beforeend', linhaPrincipal + linhaDetalhes);
  const mainRow = document.getElementById(`row_${uid}`);
  
  // Configura o Select2 para o novo select de exerc√≠cio
  const $selectExercicio = $(`#${selectId}`);
  
  // Aguarda um pouco para o DOM estar pronto
  setTimeout(() => {
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
      configurarSelect2Exercicio($selectExercicio);
    } else {
      console.error('‚ùå jQuery ou Select2 n√£o dispon√≠vel');
    }
  }, 100);
  
  // Adiciona listeners para outros campos
  mainRow.querySelectorAll('input, select:not(.select-exercicio)').forEach(el => {
    el.addEventListener('input', () => recalcularLinha(mainRow));
    el.addEventListener('change', () => recalcularLinha(mainRow));
  });
  
  // Configura checkbox para sele√ß√£o em massa
  const checkbox = mainRow.querySelector('.mass-check');
  if (checkbox) {
    checkbox.addEventListener('change', function() {
      mainRow.classList.toggle('table-active', this.checked);
    });
  }
  
  // Configura "Select All" checkbox
  const selectAllCheckbox = document.getElementById(`selectAll_${treinoId}`);
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      const isChecked = this.checked;
      tabela.querySelectorAll('.mass-check').forEach(cb => {
        cb.checked = isChecked;
        cb.dispatchEvent(new Event('change'));
      });
    });
  }
}

function adicionarAbaTreino(nome) {
  if (!nome) return;
  
  // Sanitiza o nome para evitar problemas com IDs
  const nomeSanitizado = nome.trim();
  if (nomeSanitizado.length === 0) {
    mostrarNotificacao('O nome da s√©rie n√£o pode estar vazio', 'error');
    return;
  }
  
  const id = 'treino_' + Math.random().toString(36).slice(2,7);
  
  // Verifica se j√° existe uma aba com esse nome
  const abasExistentes = Array.from(document.querySelectorAll('#abasTreino .nav-link'))
    .map(el => el.textContent.trim());
  
  if (abasExistentes.includes(nomeSanitizado)) {
    mostrarNotificacao(`J√° existe uma s√©rie chamada "${nomeSanitizado}"`, 'error');
    return;
  }
  
  const abaHTML = `
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#${id}" role="tab">
        ${nomeSanitizado}
      </a>
    </li>`;
  
  document.getElementById('abasTreino').insertAdjacentHTML('beforeend', abaHTML);

  const conteudoHTML = `
    <div class="tab-pane fade" id="${id}" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-bordered align-middle small w-100">
          <thead class="table-light">
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" class="form-check-input" id="selectAll_${id}">
              </th>
              <th>Exerc√≠cio</th>
              <th style="width: 100px;">Carga (kg)</th>
              <th style="width: 100px;">Reps</th>
              <th style="width: 80px;">Sets</th>
              <th style="width: 100px;">Descanso (s)</th>
              <th>
                M√©todo 
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="abrirEdicaoEmMassa('${id}')">
                  <i class="bi bi-pencil-square me-1"></i>Edi√ß√£o em massa
                </button>
              </th>
            </tr>
          </thead>
          <tbody id="tabelaExercicios_${id}"></tbody>
        </table>
        <button class="btn btn-outline-secondary btn-sm mt-2" onclick="adicionarExercicio('${id}')">
          <i class="bi bi-plus-circle me-1"></i>Adicionar exerc√≠cio
        </button>
      </div>
    </div>`;
  
  document.getElementById('conteudoTreinos').insertAdjacentHTML('beforeend', conteudoHTML);
  
  // Ativa a nova aba
  new bootstrap.Tab(document.querySelector(`a[href="#${id}"]`)).show();
  
  // Adiciona primeiro exerc√≠cio automaticamente
  setTimeout(() => {
    adicionarExercicio(id);
  }, 100);
}

/*****************  9. C√°lculos Autom√°ticos *****************/
function recalcularLinha(mainRow) {
  const metodo = mainRow.querySelector('[data-field="metodo"] select').value;
  const detalhesRow = mainRow.nextElementSibling;
  const notasInput = detalhesRow.querySelector('[data-field="notas"]');
  
  if (!metodo) { 
    notasInput.value = ''; 
    return; 
  }
  
  const carga = parseFloat(mainRow.querySelector('[data-field="carga"] input').value) || 0;
  const reps = parseInt(mainRow.querySelector('[data-field="repsDesejadas"] input').value) || 0;
  const sets = parseInt(mainRow.querySelector('[data-field="sets"] input').value) || 0;
  
  let resultado = '';
  
  switch (metodo) {
    case 'drop_set':
      if (carga && sets) {
        let cargaAtual = carga;
        const decremento = carga / sets;
        const series = [];
        
        for (let i = 1; i <= sets && cargaAtual > 0; i++) {
          series.push(`S${i}: ${cargaAtual.toFixed(1)}kg`);
          cargaAtual = Math.max(0, cargaAtual - decremento);
        }
        
        resultado = series.join(', ');
      }
      break;
      
    case 'bi_set':
      if (carga && reps && sets) {
        const volume = carga * reps * sets;
        resultado = `Volume total: ${volume.toFixed(1)} kg‚Ä¢rep`;
      }
      break;
      
    case 'rest_pause':
      if (reps) {
        const miniSets = Math.ceil(reps / 3);
        const repsPerSet = Math.ceil(reps / miniSets);
        resultado = `${miniSets} mini-sets de ~${repsPerSet} reps`;
      }
      break;
      
    case 'piramidal':
      if (carga && sets) {
        const series = [];
        for (let i = 1; i <= sets; i++) {
          const percentual = 50 + (50 * (i - 1) / (sets - 1));
          const cargaSet = (carga * percentual / 100).toFixed(1);
          series.push(`S${i}: ${cargaSet}kg`);
        }
        resultado = series.join(', ');
      }
      break;
      
    case 'negativa':
      if (carga) {
        const cargaExcentrica = (carga * 1.25).toFixed(1);
        resultado = `Fase exc√™ntrica: ${cargaExcentrica}kg`;
      }
      break;
  }
  
  notasInput.value = resultado;
}

/*****************  10. Edi√ß√£o em Massa *****************/
let linhasSelecionadas = [];

function abrirEdicaoEmMassa(treinoId) {
  const linhas = document.querySelectorAll(`#tabelaExercicios_${treinoId} tr.exercicio-row`);
  linhasSelecionadas = Array.from(linhas).filter(r => r.querySelector('input[type="checkbox"]')?.checked);
  
  if (!linhasSelecionadas.length) {
    mostrarNotificacao('Selecione pelo menos um exerc√≠cio para edi√ß√£o em massa', 'error');
    return;
  }
  
  document.getElementById('formEdicaoMassa').reset();
  new bootstrap.Modal(document.getElementById('edicaoMassaModal')).show();
}

/*****************  11. UI utilidades *****************/
function mostrarInputNovaSerie() { 
  document.getElementById('liAdicionarSerie').classList.add('d-none'); 
  document.getElementById('liInputSerie').classList.remove('d-none'); 
  document.getElementById('inputNomeSerie').focus(); 
}

/*****************  12. INICIALIZA√á√ÉO E EVENT LISTENERS *****************/
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöÄ Inicializando sistema de gerenciamento de exerc√≠cios...');
  
  // Carrega o gr√°fico corporal
  carregarGraficoMuscular();
  
  // Verificar depend√™ncias
  if (typeof $ === 'undefined') {
    console.error('‚ùå jQuery n√£o est√° carregado!');
    mostrarNotificacao('Erro: jQuery n√£o est√° dispon√≠vel', 'error');
    return;
  }
  
  if (typeof $.fn.select2 === 'undefined') {
    console.error('‚ùå Select2 n√£o est√° carregado!');
    mostrarNotificacao('Erro: Select2 n√£o est√° dispon√≠vel', 'error');
    return;
  }
  
  console.log('‚úÖ Todas as depend√™ncias carregadas');

  try {
    // Carrega o cache de exerc√≠cios
    await carregarExercicios();

    // Configurar input de nova s√©rie
    const inputSerie = document.getElementById('inputNomeSerie');
    if (inputSerie) {
      inputSerie.addEventListener('keydown', e => {
        if (e.key === 'Enter') { 
          const nome = inputSerie.value.trim(); 
          if (nome) adicionarAbaTreino(nome); 
          inputSerie.value = ''; 
          document.getElementById('liInputSerie').classList.add('d-none'); 
          document.getElementById('liAdicionarSerie').classList.remove('d-none');
        }
        if (e.key === 'Escape') { 
          inputSerie.value = ''; 
          document.getElementById('liInputSerie').classList.add('d-none'); 
          document.getElementById('liAdicionarSerie').classList.remove('d-none'); 
        }
      });
    }

    // Configurar sortable para as abas
    const abasTreino = document.getElementById('abasTreino');
    if (abasTreino && typeof Sortable !== 'undefined') {
      new Sortable(abasTreino, {
        filter: '#liAdicionarSerie,#liInputSerie',
        draggable: '.nav-item:not(#liAdicionarSerie):not(#liInputSerie)',
        animation: 150
      });
    }

    // Listener para quando o modal de cadastro de exerc√≠cio for fechado
    const modalCadExercicio = document.getElementById('modalCadExercicio');
    if (modalCadExercicio) {
      modalCadExercicio.addEventListener('hidden.bs.modal', function() {
        console.log('üîÑ Modal de cadastro fechado, recarregando exerc√≠cios...');
        setTimeout(() => {
          recarregarExercicios();
        }, 500);
      });
    }
    
    // Listener para o formul√°rio de cadastro de exerc√≠cio
    const formCadExercicio = document.getElementById('formCadastrarExercicio');
    if (formCadExercicio) {
      formCadExercicio.addEventListener('submit', function(e) {
        console.log('üìù Formul√°rio de exerc√≠cio submetido');
        // O recarregamento ser√° feito quando o modal for fechado
      });
    }

    // Configurar bot√£o de aplicar edi√ß√£o em massa
    const btnAplicarEdicaoMassa = document.getElementById('btnAplicarEdicaoMassa');
    if (btnAplicarEdicaoMassa) {
      btnAplicarEdicaoMassa.addEventListener('click', function() {
        const campos = [
          {k: 'carga', id: 'massa_carga'},
          {k: 'repsDesejadas', id: 'massa_repsDesejadas'},
          {k: 'sets', id: 'massa_sets'},
          {k: 'descanso', id: 'massa_descanso'}
        ];
        
        const novosValores = {};
        campos.forEach(({k, id}) => {
          const valor = document.getElementById(id).value.trim();
          if (valor) novosValores[k] = valor;
        });
        
        if (Object.keys(novosValores).length === 0) {
          mostrarNotificacao('Preencha pelo menos um campo para aplicar', 'error');
          return;
        }
        
        // Aplica os novos valores
        linhasSelecionadas.forEach(row => {
          Object.entries(novosValores).forEach(([campo, valor]) => {
            const input = row.querySelector(`[data-field="${campo}"] input`);
            if (input) {
              input.value = valor;
              input.dispatchEvent(new Event('change'));
            }
          });
          
          recalcularLinha(row);
        });
        
        bootstrap.Modal.getInstance(document.getElementById('edicaoMassaModal')).hide();
        mostrarNotificacao(`Altera√ß√µes aplicadas em ${linhasSelecionadas.length} exerc√≠cio(s)`, 'success');
      });
    }

    // Cria primeira aba se n√£o existir nenhuma
    if (document.querySelectorAll('#abasTreino .nav-item:not(#liAdicionarSerie):not(#liInputSerie)').length === 0) {
      adicionarAbaTreino('S√©rie A');
    }

    console.log('‚úÖ Sistema inicializado com sucesso');
    
  } catch (error) {
    console.error('‚ùå Erro na inicializa√ß√£o:', error);
    mostrarNotificacao('Erro ao inicializar o sistema', 'error');
  }
});
</script>
{% endblock %}