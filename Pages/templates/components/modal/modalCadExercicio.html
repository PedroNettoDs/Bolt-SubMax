<!-- Modal para cadastro de  exercício -->
<div class="modal fade" id="modalCadExercicio" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Formulário com POST e action definido -->
      <form id="formCadastrarExercicio" method="post" action="{% url 'cadastrar_exercicio' %}">
        {% csrf_token %}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalCadExercicioTitulo">
            <i class="bi bi-plus-circle me-2"></i>Cadastrar Exercício
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- Campo: Nome do Exercício -->
          <div class="mb-3">
            <label class="form-label" for="exercicioNome">Nome do Exercício</label>
            <input type="text" class="form-control" id="exercicioNome" name="nome" placeholder="Ex: Agachamento" required>
          </div>

          <!-- Campo: Descrição -->
          <div class="mb-3">
            <label class="form-label" for="exercicioDescricao">Descrição</label>
            <textarea class="form-control" id="exercicioDescricao" name="descricao" placeholder="Descreva o exercício" rows="2"></textarea>
          </div>

          <!-- Campo: Categoria -->
          <div class="mb-3">
            <label class="form-label" for="categoria">Categoria</label>
            <select class="form-select" id="categoria" name="categoria" required>
              <option value="aquecimento">Aquecimento</option>
              <option value="forca">Força</option>
              <option value="resistencia">Resistência</option>
              <option value="flexibilidade">Flexibilidade</option>
              <option value="potencia">Potência</option>
              <option value="agilidade">Agilidade</option>
              <option value="equilibrio">Equilíbrio</option>
            </select>
          </div>

          <!-- Campo: Grupo Muscular -->
          <div class="mb-3">
            <label for="grupo_muscular" class="form-label">Grupo Muscular</label>
            <select
              multiple
              class="form-select selectpicker"
              id="grupo_muscular"
              name="grupo_muscular"
              data-live-search="true"
              data-actions-box="true"
              data-max-options="2"
              required>
              <option value="trapezius">Trapézio</option>
              <option value="chest">Peitoral</option>
              <option value="back">Costas</option>
              <option value="shoulders">Ombros</option>
              <option value="biceps">Bíceps</option>
              <option value="triceps">Tríceps</option>
              <option value="brachialis">Braquial</option>
              <option value="forearms">Antebraços</option>
              <option value="abs">Abdômen</option>
              <option value="obliques">Oblíquos</option>
              <option value="lombar">Lombar</option>
              <option value="iliopsoas">Iliopsoas</option>
              <option value="glutes">Glúteos</option>
              <option value="quadriceps">Quadríceps</option>
              <option value="hamstrings">Posterior de Coxa</option>
              <option value="calves">Panturrilhas</option>
              <option value="adductors">Adutores</option>
              <option value="abductors">Abdutores</option>
              <option value="cardio">Cardio</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnSalvarExercicio">Salvar Exercício</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('formCadastrarExercicio');
    const grupoSelect = $('#grupo_muscular');

    // Inicializa plugin bootstrap-select
    grupoSelect.selectpicker();

    if (form) {
      form.addEventListener('submit', function (e) {
        // Validação manual dos campos obrigatórios
        const camposObrigatorios = form.querySelectorAll('[required]');
        let formularioValido = true;
        let primeiroInvalido = null;

        camposObrigatorios.forEach(campo => {
          let valor;
          if (campo.tagName === 'SELECT' && campo.multiple) {
            valor = $(campo).val();
          } else {
            valor = campo.value.trim();
          }

          const vazio = !valor || (Array.isArray(valor) && valor.length === 0);
          if (vazio) {
            campo.classList.add('is-invalid');
            campo.classList.remove('is-valid');
            formularioValido = false;
            if (!primeiroInvalido) {
              primeiroInvalido = campo;
            }
          } else {
            campo.classList.remove('is-invalid');
            campo.classList.add('is-valid');
          }

          // Corrige em tempo real
          const evento = campo.tagName === 'SELECT' ? 'change' : 'input';
          campo.addEventListener(evento, () => {
            let val;
            if (campo.tagName === 'SELECT' && campo.multiple) {
              val = $(campo).val();
              const isEmpty = !val || val.length === 0;
              campo.classList.toggle('is-invalid', isEmpty);
              campo.classList.toggle('is-valid', !isEmpty);
            } else {
              const texto = campo.value.trim();
              campo.classList.toggle('is-invalid', !texto);
              campo.classList.toggle('is-valid', !!texto);
            }
          });
        });

        if (!formularioValido && primeiroInvalido) {
          e.preventDefault(); // Impede envio se inválido
          primeiroInvalido.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    }

    // Limpar formulário quando modal for fechado
    const modal = document.getElementById('modalCadExercicio');
    if (modal) {
      modal.addEventListener('hidden.bs.modal', function() {
        form.reset();
        form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
          el.classList.remove('is-valid', 'is-invalid');
        });
        grupoSelect.selectpicker('deselectAll');
      });
    }
  });
</script>